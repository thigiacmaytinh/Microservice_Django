{% extends 'base.html' %}
{% block head %}
<title>Kiểm tra ảnh mẫu bất thường</title>
{% endblock %} 

{% block body %}
<br/>



<!-- query panel -->
<div class=" panel panel-primary">
    <div class="panel-heading">
        Kiểm tra ảnh mẫu bất thường
        <span id="lbl_maxPerson"></span>
        <div id="loading_icon" class="spinner-border" role="status" style="display: none;"></div>
    </div>
    <div class="container-fuid panel-body form-inline">
        <div class="row" style="padding-left:10px">
            {% if level == "Root" %}           
            <div id="div_org" class="input-group col-md-2" >                                
                <select class="form-control cb_owner" id="cb_owner"></select>
            </div>
            {% endif %}
            <div id="div_personGroup" class="input-group col-md-2">                                
                <select class="form-control" id="cb_type"></select>
            </div>            
            <div class="input-group col-md-3">                                
                <input type="text" placeholder="Họ tên/mã số/sdt/cmnd" name="text" id='txt_search' class="form-control "> 
            </div>
            <div class="input-group col-md-1">
                <button id ="btn_search" class="btn btn-primary btn-default"><i class="fas fa-search"></i> Tìm kiếm</button>
            </div>
            <!-- <div class="input-group col-md-1">
                <button id="btn_reportExcel" class="btn btn-success btn-default">
                    <span class="fas fa-file-excel"></span> Xuất Excel</button>
            </div> -->
            
            <div id="div_upload" class="input-group col-md-1">
                <a class="btn btn-outline btn-sq-lg btn-primary btn-default" id="frm_upload">
                    <i class="fas fa-upload"></i>
                    <span>Upload ảnh để tìm</span>                        
                </a>                        
                <input name="uploadFile" id="uploadFile" type="file" class="inputFile" style="display: none;"/> 
            </div>
            
            
            <a id="btn_showPanel" href="#0" class="js-cd-panel-trigger" data-panel="main" style="visibility: hidden;">Fire Panel</a>
            
        </div>
        <div class="row col-md-12" style="margin-top: 5px;">
            <div style="width:fit-content; float: left;">
                <select class="form-control" id="cb_showAmount"></select>
            </div>
            <div class="col-md-2" style="min-width: 300px;">
                <input type="radio" id="rd_asc" name="order_by" class="custom-checkbox" > Cũ nhất trước &nbsp;&nbsp;&nbsp;
                <input type="radio" id="rd_desc" name="order_by" class="custom-checkbox" checked> Mới nhất trước &nbsp;&nbsp;&nbsp;
            </div>
            <input type="checkbox" id="chk_showKnownPersonOnly" class="custom-checkbox"> Chỉ hiện người quen
        </div>
    </div>
</div>
<!-- query panel end -->


<div class="cd-panel cd-panel--from-right js-cd-panel-main" style="z-index: 1001;">    
    <header class="cd-panel__header" >
        <h2 style="margin: 8px;">Thông tin chi tiết</h2>
        <a id="btn_closePanel" href="#0" class="cd-panel__close js-cd-close">Close</a>
    </header>
    <div class="cd-panel__container">        
        <div id="person_field" class="cd-panel__content">       

            <div id="div_webcam" class="col-md-12">
                <div id="container">
                    <canvas class="center-block" id="canvasOutput" width=320 height=240></canvas>
                </div>
                <div class="invisible">
                    <video id="video" class="hidden">Your browser does not support the video tag.</video>
                </div>
                <center>
                    <button id ="btn_capture" class="btn btn-default btn-success"><span class="fa fa-camera"></span> Chụp ảnh</button> 
                </center>
            </div>

            <div class="form-group col-md-12">
                <button id ="btn_addMoreImage" class="btn btn-default btn-success"><span class="fa fa-camera"></span> Thêm ảnh mẫu từ Webcam</button>
                <button id ="btn_select" class="btn btn-default btn-success"><i class="fas fa-image"></i> Thêm ảnh mẫu từ file</button>
                <input name="uploadImage" id="uploadImage" type="file" class="inputFile" style="display: none;"/> 
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Person ID</span>
                <div class="col-md-9">
                    <input type="text" id='txt_personID' class="form-control" disabled>
                </div>
            </div>


            <div class="col-md-12">
                <span class="col-md-3">Họ tên *</span>
                <div class="col-md-9">
                    <input type="text" id='txt_fullName' class="form-control">
                </div>
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Giới tính</span>                
                <div class="col-md-9">
                    <input type="radio" id="rd_male" name="gender" class="custom-checkbox"> Nam &nbsp;&nbsp;&nbsp;
                    <input type="radio" id="rd_female" name="gender" class="custom-checkbox"> Nữ &nbsp;&nbsp;&nbsp;
                    <input type="radio" id="rd_undefined" name="gender" class="custom-checkbox" checked> Không biết
                </div>                
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Số điện thoại</span>
                <div class="col-md-9">
                    <input type="text" id='txt_phone' class="form-control">
                </div>
            </div>

            {% if level == "Root" %}
            <div id="div_owner2" class="col-md-12">
                <span class="col-md-3">Tổ chức</span>
                <div class="col-md-9">
                    <select id="cb_owner2" class="form-control cb_owner" ></select>
                </div>
            </div>
            {% endif %}

            <div class="col-md-12">
                <span class="col-md-3">Phân loại
                    <i data-html="true" class="fa fa-question-circle" data-toggle="tooltip" 
                        title="Chọn nhân viên để chấm công"></i>
                </span>
                <div class="col-md-9">
                    <input type="radio" id="rd_guest" name="personType" class="custom-checkbox"> Khách hàng &nbsp;&nbsp;&nbsp;
                    <input type="radio" id="rd_staff" name="personType" class="custom-checkbox"> Nhân viên &nbsp;&nbsp;&nbsp;                    
                </div>                
            </div>

            <div id="div_shift" class="col-md-12">
                <span class="col-md-3">Giờ vào</span>
                <span class="col-md-3">
                    <input id="txt_startShift" type="text" class="form-control time" value="00:00" onkeypress='AllowNumberOnly(event)'/>
                </span>
                <span class="col-md-3" style="text-align: right;">Giờ ra</span>
                <span class="col-md-3">
                    <input id="txt_endShift" type="text" class="form-control time" value="00:00" onkeypress='AllowNumberOnly(event)'/>
                </span>
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Nhóm</span>                
                <div class="col-md-7">
                    <select id="cb_type2" class="form-control"></select>                    
                </div>
                <button id ="btn_showModalGroup" class="btn btn-default btn-success" style="height: 32px;"><span class="fa fa-plus"></span></button>
            </div>


            <div class="col-md-12">
                <span class="col-md-3">Năm sinh</span>            
                <div class="col-md-9">
                    <input type="date" name="text" id='txt_birthday' class="form-control ">
                </div>                 
            </div>


            <div class="col-md-12">
                <span class="col-md-3">CMND/CCCD</span>            
                <div class="col-md-9">                    
                    <input type="text" id='txt_cmnd' class="form-control">
                </div>                 
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Ngày cấp</span>            
                <div class="col-md-9">
                    <input type="date" name="text" id='txt_issuedDate' class="form-control ">
                </div>
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Địa chỉ</span>            
                <div class="col-md-9">      
                    <textarea id="txt_address" class="form-control" rows="3"></textarea>
                </div>                 
            </div>

            <div class="col-md-12">
                <span class="col-md-3">Ghi chú</span>            
                <div class="col-md-9">                    
                    <textarea class="form-control" id="txt_note" rows="3"></textarea>
                </div>                 
            </div>

            <center style="margin-bottom: 20px;">
                <button id ="btn_update" class="btn btn-default btn-success"><span class="fa fa-save"></span> Cập nhật</button>
                <button id ="btn_delete" class="btn btn-default btn-danger"><span class="fa fa-minus"></span> Xóa</button>
                <button id ="btn_addPerson" class="btn btn-default btn-success"><span class="fa fa-plus"></span> Thêm người</button>
            </center>
            
            
            <div id="div_merge" class="row">
                <div class="col-md-12">
                    <h3 style="margin: 10">Gộp vào khách hàng có sẵn</h3>
                </div>                

                <div class="col-md-12">
                    <span class="col-md-3">Tìm kiếm</span>
                    <div class="col-md-9">
                        <input type="text" id='txt_searchPerson' class="form-control">
                    </div>
                </div>
    
                <div class="col-md-12">
                    <span class="col-md-3">Kết quả</span>
                    <div class="col-md-9">
                        <input type="text" id='txt_result' class="form-control" disabled>
                    </div>
                </div>
    
    
                <div class="col-md-12">
                    <center>
                        <button id ="btn_merge" class="btn btn-default btn-success" disabled><span class="fa fa-plus"></span> Gộp</button>
                    </center>
                </div>
            </div>


            </br></br>

            <div class="panel panel-default" id="panel_image" style="margin-bottom: 50px;">    
                <div class="panel-heading" style="background-color:lightskyblue !important;">
                    <span id="lbl_count">Ảnh mẫu</span>            
                </div>
                <div class="panel-body">
                    <div class="table-responsive col-md-12">
                        <table class="table" id="table_image">                          
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- sample person sumary -->
        </div> <!-- cd-panel__content -->
    </div> <!-- cd-panel__container -->
</div> <!-- cd-panel -->




<nav id="paging" style="margin-top: -15px; display: block;" class="paging pull-right" hidden>
    <ul class="pagination">                
    </ul>
</nav>


<div class="panel panel-default" id="panel_person">
    <div class="panel-heading">
        <span id="lbl_countResult"> </span> 
    </div>
    <!-- /.panel-heading -->
    <div class="panel-body">
        <div class="table-responsive" style="overflow-x: inherit !important;">
            <table class="table table-hover" id="table_person">
                <thead class="bg-info">
                    <tr> 
                        <th>STT</th>      
                        <th>Hình ảnh</th>
                        <th>Họ tên</th>
                        <th>Error</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <!-- /.table-responsive -->
    </div>
    <!-- /.panel-body -->
</div>
<!-- sample person sumary -->

<nav id="paging_bottm" class="paging pull-right" hidden>
    <ul class="pagination">                
    </ul>
</nav>


<div class="modal fade" id="modal_group" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content panel-yellow">
            <div class="modal-header panel-heading">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" id="lbl_modal_title">Tạo nhóm</h4>
            </div>
            <div class="modal-body panel-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <input type="text" class="form-control" id="txt_group_name" placeholder="Tên nhóm *">
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="chk_alert" class="custom-checkbox"> Thông báo khi xuất hiện
                        </div>     
                    </div>
                    <div class="col-md-12">
                        <button id ="btn_createGroup" class="btn btn-default btn-success pull-right"><span class="fa fa-plus"></span> Thêm nhóm</button>
                    </div>
                    </div>
                </div>         
            </div>  
        </div>
    </div>
</div> 



<div class="modal fade" id="modal_image" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content panel-primary">
            <div class="modal-header panel-heading">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Bạn có chắc chắn muốn xóa ảnh?</h4>
            </div>
            <div class="modal-body panel-body">
                <div class="slideshow-container" id="slideshow-body">
                </div>

                <br>
                <div style="text-align:center" id="slider"> </div>
                    <button id="btn_deleteImage" class="btn btn-default btn-danger pull-right">
                        <span class="fa fa-minus"></span> Xóa ảnh</button>

            </div>
            <!-- end modal body-->

        </div>
    </div>
</div>



{% endblock %} {% block scripts %}
<script>
g_mode = "" //image - webcam
g_base64_string = ""
g_currentPage = 1
g_numPage = 0
g_numResultPerPage = 50
g_person_pk = ""
g_persons = null
g_person = null
g_newPerson_pk = ""
g_newPerson = null
let faceClassifier = null;

let src = null;
let dstC1 = null;
let dstC3 = null;
let dstC4 = null;

let canvasInput = null;
let canvasInputCtx = null;

let canvasBuffer = null;
let canvasBufferCtx = null;
isFirst = true

let g_videoWidth = 640
let g_videoHeight = 480;
g_aspect = window.screen.availWidth / window.screen.availHeight

// whether g_playing video from the camera.
let g_playing = false;
let g_isSending = false;

let video = document.getElementById('video');
let canvasOutput = document.getElementById('canvasOutput');
let canvasOutputCtx = canvasOutput.getContext('2d');
let stream = null;

strOwners = String.raw`{{ owners|safe }}`
g_owners = JSON.parse(strOwners);
g_inited = false

$(document).ready(function () 
{
    SetCallbackClosePanel('js-cd-panel-main')

    SetDate($('#txt_from_date'))
    SetDate($('#txt_to_date'))

    if("{{level}}" == "Root")
    {
        DisplayOwners()
    }

        
    $('#cb_type').append($("<option></option>").attr("value", "").text("Chọn loại bất thường"));
    $('#cb_type').append($("<option></option>").attr("value", "Brightness").text("Bright/Dark"));
    $('#cb_type').append($("<option></option>").attr("value", "Hidden").text("Hidden/Mask"));
    $('#cb_type').append($("<option></option>").attr("value", "Angle").text("Angle"));
    $('#cb_type').append($("<option></option>").attr("value", "Landmark").text("Landmark exist"));

    
    
    $('#cb_showAmount').append($("<option></option>").attr("value", "10").text("10"));
    $('#cb_showAmount').append($("<option></option>").attr("value", "20").text("50"));
    $('#cb_showAmount').append($("<option></option>").attr("value", "50").text("50"));
    $('#cb_showAmount').append($("<option></option>").attr("value", "100").text("100"));
    $('#cb_showAmount').append($("<option></option>").attr("value", "200").text("200"));
    $('#cb_showAmount').append($("<option></option>").attr("value", "500").text("500"));
    

    if(Cookies.get("numResultPerPage_person") != null)
    {
        g_numResultPerPage = Cookies.get("numResultPerPage_person")
    }
    $('#cb_showAmount').val(g_numResultPerPage)

    if(Cookies.get('order_by_person') != null)
    {
        if(Cookies.get('order_by_person') == "asc")
            document.getElementById("rd_asc").checked = true
        else
            document.getElementById("rd_desc").checked = true
    }
    if(Cookies.get("showKnownPersonOnly_person") != null)
    {
        document.getElementById("chk_showKnownPersonOnly").checked = Cookies.get("showKnownPersonOnly_person") == "True"
    }

    
    var strSearch = findGETParameter("pk")        
    if(strSearch != null && strSearch != "")
    {
        $("#txt_search").val(strSearch)
    }

    g_inited = true

    $('.time').timepicker({'timeFormat': 'H:i'});
});+

$('#chk_showKnownPersonOnly').change(function() {
    SearchAbnormal()
    Cookies.set('showKnownPersonOnly_person', document.getElementById("chk_showKnownPersonOnly").checked ? "True" : "False", { expires: 365 });
});

$('input[type=radio][name=personType]').change(function() {
    if(document.getElementById("rd_staff").checked)
    {
        if("{{level}}" == "Root" || "{{email}}" == "anhvietlienket@gmail.com")
            $("#div_shift").show()
    }
    else
    {
        $("#div_shift").hide()
    }
});


function SetCallbackClosePanel(panelClass)
{
    panel = document.getElementsByClassName(panelClass)[0];
    panel.addEventListener('click', function(event){
        if( hasClass(event.target, 'js-cd-close') || hasClass(event.target, panelClass)) {
            stopCamera()
            canvasInput = null
        }

        if($(event.target)[0].nodeName == "IMG")
        {
            $(".mySlides").remove()

            imgDiv = document.createElement("div")
            imgDiv.setAttribute("class", "mySlides")
            img = document.createElement("img")
            img.id = "image_popup"
            img.src = $(event.target)[0].src
            img.style = "width:100%; "
            imgDiv.style = "display: block;"
            imgDiv.appendChild(img)
            
            var slideshow = document.getElementById('slideshow-body');
            slideshow.append(imgDiv)

            $("#modal_image").modal()
        }
    });
}


$("#btn_search").click(function () {
    SearchAbnormal( $('#cb_owner').find(":selected").val())
})

$('#cb_owner').on('change', function() {
    OnOwnerChanged()
});

function OnOwnerChanged()
{
    Cookies.set('owner', $('#cb_owner').find(":selected").val(), { expires: 365 });
    SearchAbnormal()
}

$('#cb_type').on('change', function() {
    SearchAbnormal()
});


function FindSimilarPerson(files)
{
    if(files.length == 0)
        return
    if(g_isSending)
    {
        ShowToast("Please wait...")
        return
    }

    $('#table_person > tbody tr').remove()
    document.getElementById("loading_icon").style.display = "inline-block"
    var myFormData = new FormData();
    myFormData.append('selectedFile', files[0]);
    if("{{level}}" == "Root")
    {
        myFormData.append('owner', $('#cb_owner').find(":selected").val());
    }    
    myFormData.append("token", Cookies.get("token"));
    
    host_request = gethost() + "/api/person/getSimilar"
    ajaxUpload("POST", host_request, myFormData, OnFindSimilarSuccess, OnUploadFileFailed);
    g_isSending = true
}

function OnFindSimilarSuccess(res)
{
    g_isSending = false
    $(".paging ul > li").remove()
    g_currentPage = 1
    g_numPage = 1

    g_persons = res
    if(g_persons.length == 0)
    {
        showError("Không tìm thấy khách hàng")
        return
    }
    for(let i=0; i<g_persons.length; i++)
    {
        $('#table_person > tbody:last-child').append(genRow(g_persons[i], (i+1)))
    }
    
    mostSimilar = g_persons[0]
    document.getElementById("lbl_countResult").innerText = "Người giống nhất: " + mostSimilar.percent + "% => " 
            + (mostSimilar.percent >= "{{THRESHOLD}}" ? "GIỐNG" : "KHÔNG GIỐNG")
    $("#lbl_countResult").css("color", mostSimilar.percent >= "{{THRESHOLD}}" ? "green" : "red")    // 
    document.getElementById("loading_icon").style.display = "none"
    $("#uploadFile").val(null);
}

function OnUploadFileFailed(res)
{
    g_isSending = false
    $("#uploadFile").val(null);
    showError(res["responseJSON"]["Error"])
    document.getElementById("loading_icon").style.display = "none"
}



$("#btn_merge").click(function () {
    host_request = gethost() + '/api/person/merge'
    request_data = {
        "person_pk": g_person_pk,
        "mergeInto": g_newPerson_pk,
        "token": Cookies.get("token"),
    }
    if("{{level}}" == "Root")
    {
        request_data["owner"] = $('#cb_owner').find(":selected").val()
    }

    ajaxRequest("POST", host_request, request_data, onMergePersonSuccess, function(res){
        ShowToast(GetErrorMessage(res))
    })
})

function onMergePersonSuccess(res)
{
    $("#txt_searchPerson").val("")
    $("#txt_result").val("")
    document.getElementById("btn_merge").disabled = true

    $('#btn_closePanel')[0].click();
    SearchAbnormal()
    ShowToast(res.Success)
}

function DisplayOwners(res)
{   
    $('#cb_owner').append($("<option></option>").attr("value", "all").text("Tất cả tổ chức"));

    for(i = 0; i < g_owners.length; i++)
    {
        $('.cb_owner')
            .append($("<option></option>")
            .attr("value", g_owners[i].email)
            .text(g_owners[i].email));
    }
    if(Cookies.get("owner") != null)
    {
        $("#cb_owner").val(Cookies.get("owner"))
        OnOwnerChanged()
    }

    SearchAbnormal()
}

$(".paging").on('click', '.page-link', function(event) {
    currentPage = g_currentPage
    if($(this).text() == "Next")
    {
        if(g_currentPage  < g_numPage )
            g_currentPage += 1            
    }            
    else if($(this).text() == "Previous")
    {
        if(g_currentPage > 1)
            g_currentPage -= 1
    }            
    else
        g_currentPage = parseInt($(this).text())

    if(currentPage != g_currentPage)
        SearchAbnormal()
})

$("#chk_merge").change(function() {
    document.getElementById("cb_person").disabled = !this.checked;
    document.getElementById("btn_merge").disabled = !this.checked;
});

$("#btn_showRegisterPanel").click(function () {
    startCamera();
    
    $("#txt_personID").val("")
    $("#txt_fullName").val("")
    $("#txt_phone").val("")
    $("#txt_birthday").val("")
    $("#txt_cmnd").val("")
    $("#txt_issuedDate").val("")
    $("#txt_address").val("")
    $("#txt_note").val("")

    $("#btn_addMoreImage").hide()
    $("#div_webcam").show()
    $("#btn_addPerson").show()
    $("#btn_update").hide()
    $("#btn_delete").hide()
    $("#panel_image").hide()
    $("#div_merge").hide()

    $("#cb_type2").val("");
    document.getElementById("rd_undefined").checked = true
    document.getElementById("rd_guest").checked = true

    $('#btn_showPanel')[0].click();
})

$("#btn_capture").click(function () {
    if(g_playing)
    {
        $("#btn_capture").html("<span class='fa fa-redo'></span> Chụp lại");        
        stopCamera()
    }        
    else
    {
        $("#btn_capture").html("<span class='fa fa-camera'></span> Chụp ảnh");
        startCamera()
    }
})

function SearchAbnormal(owner)
{    
    if($('#cb_type').find(":selected").val() == "Brightness")
        CheckBrightness()
    else if($('#cb_type').find(":selected").val() == "Landmark")
        CheckLandmarkExist()
}

function CheckBrightness()
{
    if(!g_inited) return
    if(g_isSending)
    {
        ShowToast("Please wait...")
        return
    }
    request_data = ParamSearchBuilder($('#cb_owner').find(":selected").val())

    $('#table_person > tbody tr').remove()
    $(".paging ul > li").remove()

    let host_request = gethost() + '/api/diag/abnormal'
    
    ajaxRequest("POST", host_request, request_data, onSearchPersonSuccess, function(res)
    {
        g_isSending = false
        ShowToast(GetErrorMessage(res))
    })
    g_isSending = true
}

function CheckLandmarkExist()
{
    if(!g_inited) return
    if(g_isSending)
    {
        ShowToast("Please wait...")
        return
    }
    request_data = ParamSearchBuilder($('#cb_owner').find(":selected").val())

    $('#table_person > tbody tr').remove()
    $(".paging ul > li").remove()

    let host_request = gethost() + '/api/diag/landmarkexist'
    
    ajaxRequest("POST", host_request, request_data, onSearchPersonSuccess, function(res)
    {
        g_isSending = false
        ShowToast(GetErrorMessage(res))
    })
    g_isSending = true
}

function ParamSearchBuilder(owner)
{
    if(owner == null && "{{level}}" == "Root")
    {
        owner = $('#cb_owner').find(":selected").val()
    }

    request_data = {
        "owner" : owner,
        "search_string": $("#txt_search").val(),        
        "group_pk": $('#cb_type').find(":selected").val(),
        "showKnownPersonOnly" : document.getElementById("chk_showKnownPersonOnly").checked ? "True" : "False",
        "contentPerPage" : g_numResultPerPage,
        "pageNum" : g_currentPage,
        "order_by" : (document.getElementById("rd_asc").checked ? "asc" : "desc"),
        "token": Cookies.get("token"),
    }    
    return request_data
}

function onSearchPersonSuccess(res)
{        
    g_isSending = false
    g_persons = res.objects
    
    document.getElementById("lbl_countResult").innerText = "Có " + res["totalObject"] + " kết quả"
    $("#lbl_countResult").css("color", "black")
    if(g_persons.length ==0)
    {
        ShowToast("Không tìm thấy khách hàng")
        return
    }

    g_numPage = res["num_pages"]
    if(g_currentPage > g_numPage)
        g_currentPage = 1

    if(res["has_previous"] == true)
        $(".paging ul").append('<li class="page-item"><a class="page-link" href="#">Previous</a></li>');
    else
        $(".paging ul").append('<li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>');
    
    for(i=1; i<=g_numPage; i++)
    {
        if(g_currentPage == i)
            $(".paging ul").append('<li class="page-item active"><a class="page-link" id="btn_' + i + '" class="page-link" href="#">' + i  +'</a></li>');
        else
            $(".paging ul").append('<li class="page-item"><a class="page-link" id="btn_' + i + 'class="page-link" href="#">' + i + '</a></li>');
    }

    if(res["has_next"] == true)
        $(".paging ul").append('<li class="page-item"><a class="page-link" href="#">Next</a></li>');
    else
        $(".paging ul").append('<li class="page-item disabled"><a class="page-link" href="#">Next</a></li>');

    
    for(i = 0; i < g_persons.length; i++)
    {
        $('#table_person > tbody:last-child').append(genRow(g_persons[i], i))
    }

    $('.aniimated-thumbnials').lightGallery({
        thumbnail: true,
        selector: 'a'
    });
    $(".paging").show()
}


function genRow(person, order) 
{
    row ='<tr class="trow aniimated-thumbnials" id="">' +
            "<td>" + (order + 1 ) + "</td>"  +  
            '<td>' + (person.imgPath == null ? "" : '<a id="link_image" href="/media/' + person.imgPath + '"><img src="/media/' + person.imgPath +'" width="100px" height="100px">') + '</a></td>' +
            "<td><b>" + person.personID + "</b></td>" +
            "<td>" + person.error + "</td>" +
            "<td><button onClick=DeleteAvatar('" + order + "')>Delete</button>" + "</td>"

    row += '</tr>'
    return row
}
$("#btn_closePanel").click(function () 
{
    stopCamera()
    canvasInput = null
})



$("#btn_select").click(function () {    
    stopCamera()
    $("#btn_capture").hide()
    $("#btn_addMoreImage").show()
    $("#uploadImage").click()
})



$("#txt_search").keyup(function(event) {
    if (event.keyCode === 13) {
        SearchAbnormal()
    }
});

$('#cb_showAmount').on('change', function() {
    g_numResultPerPage = $("#cb_showAmount").find(":selected").val()
    Cookies.set("numResultPerPage_person", g_numResultPerPage, { expires: 365 })
    SearchAbnormal()
});

$('input[type=radio][name=order_by]').change(function() {
    if(this.id == "rd_asc"){
        Cookies.set('order_by_person', 'asc', { expires: 365 });
    }
    else
    {
        Cookies.set('order_by_person', 'desc', { expires: 365 });
    }
    SearchAbnormal()
});



function DeleteAvatar(personIndex) {
    person = g_persons[personIndex]
    host_request = host + '/api/person/deleteImage'
    
    request_data = {
        "personID" : person.personID,
        "imagePath" : person.imgPath,
        "token": Cookies.get("token"),
    }

    ajaxRequest("POST", host_request, request_data, OnDeleteImageSuccess, genericFailCB)
}

function OnDeleteImageSuccess(res)
{
    $("#modal_image").modal("hide")
    ShowToast(res.Success)
    // GetImagesOfPerson(g_person._id.$oid)
    // SearchAbnormal()
}

$("#table_person").on( "click", "tbody tr",function( e ) 
{
    if(e.target.nodeName == "INPUT" || e.target.nodeName == "IMG") return
})


</script>

 {% endblock %}